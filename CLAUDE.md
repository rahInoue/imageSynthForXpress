# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Image Synthesizer for Xpress (imageSynthForXpress) is an acrylic sheet printing tool that composites character images with backgrounds and generates multiple print-ready layers including cutlines, glare effects, character silhouettes, and background knockouts.

**Core workflow**: Download images from CloudFlare R2 → Generate order JSON → Synthesize layers (Python) → Generate Adobe Illustrator files (macOS only)

## Development Commands

### Complete Workflow (Recommended)
```bash
# Download images, generate order data, and create AI files
npm run download-order-images && \
npm run make-order-images && \
./process_all.sh -i output/order_images.test.json

# Parallel processing version (faster for large batches)
python3 index_parallel.py --images "$(cat output/order_images.test.json)" --sheet 280x580
```

### Individual Steps
```bash
# Download images from CloudFlare R2
npm run download-order-images

# Generate order image list from order info
npm run make-order-images

# Generate PNG layers (350 DPI print resolution)
python3 index.py --images "$(cat images.test.json)" --sheet 280x580

# Generate Adobe Illustrator files (requires macOS + Illustrator)
./run_ai.sh

# Process by receive type (event pickup vs delivery)
./process_by_receive_type.sh
```

### Dependencies Installation
```bash
# Python dependencies
pip install Pillow

# Node.js dependencies
npm install
```

## Architecture

### Multi-Language Pipeline
The system uses three languages for different stages:

1. **Node.js** (Data preparation)
   - `downloadOrderImages.js`: Downloads images from CloudFlare R2 based on order list
   - `makeOrderImages.js`: Merges order info and goods list into a single JSON for image synthesis
   - `makeOrderSummarySheets.js`: Generates order summary sheets with thumbnails and shipping info

2. **Python** (Image synthesis - 350 DPI print quality)
   - `index.py`: Main synthesis engine - generates 7 layer types (cutline, glare, character, char_knock, bg_knock, background, labels)
   - `index_parallel.py`: Parallel processing version using multiprocessing for large batches
   - `filter_by_receive_type.py`: Filters orders by receiveType (0=event pickup, 1=delivery)

3. **ExtendScript (JSX)** (Adobe Illustrator automation - macOS only)
   - `import_layers_to_ai.jsx`: Batch converts PNG layers to AI files
   - `import_layers_to_ai_fast.jsx`: Optimized version with reduced wait times
   - `import_layers_to_ai_by_receive_type.jsx`: Processes event pickup vs delivery separately

### Layer Generation System
Each card generates 7 PNG layers at 350 DPI:
- **cutline**: Black cutting guidelines + key labels
- **glare**: Glare effect (black silhouette)
- **character**: Main character image (transparent PNG)
- **char_knock**: Character knockout (black silhouette for white printing)
- **bg_knock**: Background knockout (black for transparent areas)
- **background**: Background image (cropped to cover card area)
- **labels**: Key identifiers for production tracking

### Key Parameters (index.py)
```python
CARD_PX = (768, 1024)           # Fixed card size in pixels
CUTLINE_MM = 2.0                # Cutting guideline width
MARGIN_MM = 10.0                # Sheet outer margin
SPACING_MM = 10.0               # Card spacing
KNOCKOUT_SHRINK_MM = 0.1        # Knockout shrink amount (critical for print quality)
DPI = 350                       # Print resolution
```

### Data Flow
```
Order JSON (202508/2025_order_goods_list.json)
    ↓ [makeOrderImages.js]
Image List (output/order_images.json)
    ↓ [index.py or index_parallel.py]
PNG Layers (output/1/, output/2/, ...)
    ↓ [import_layers_to_ai.jsx via run_ai.sh]
AI Files (ai_output/1.ai, 2.ai, ...)
```

### Automated Page Layout
- Cards are automatically arranged in a grid based on sheet size (default: 280x580mm)
- If cards exceed one sheet, they're split across multiple pages (output/1/, output/2/, etc.)
- Use `--one-page` flag to force all cards onto a single sheet (may overflow)

### Image Handling Strategy
- **Characters**: No upscaling by default (`ALLOW_UPSCALE_CHAR = False`) - maintains quality by letterboxing
- **Backgrounds**: Upscaling allowed (`ALLOW_UPSCALE_BG = True`) - cover-mode cropping to fill card area
- All images maintain aspect ratio and are centered

## Order Data Format

### Input: 2025_order_goods_list.json
```json
[
  {
    "orderId": 9,
    "shouhinId": 105212,
    "backgroundFlg": 1,
    "amount": 1,
    "shouhinNaiyou": "images/main/105212.png",
    "bgFlg": "illustDisplay/bg/Z73_bg.png",
    "logoPath": "illustDisplay/logo/Z73_logo.png",
    "receiveType": 0
  }
]
```

### Output: order_images.json (generated by makeOrderImages.js)
```json
[
  {
    "key": "9_105212",
    "char": "images/main/105212.png",
    "bg": "illustDisplay/bg/Z73_bg.png",
    "logo": "illustDisplay/logo/Z73_logo.png",
    "orderId": "9",
    "userId": "Ktd4NZXlfRhTKrlPpqCjkRt1g0u1",
    "userName": "橋本咲良",
    "amount": 1
  }
]
```

## Important Implementation Notes

### Knockout Generation
The knockout layers (char_knock, bg_knock) are critical for print quality:
- `KNOCKOUT_SHRINK_MM = 0.1`: Controls how much to shrink the knockout (reduced from 0.2 for tighter registration)
- `KNOCKOUT_THRESHOLD = 20`: Alpha values below this are ignored
- `KNOCKOUT_MIN_ALPHA = 80`: Minimum opacity to be included in knockout

When modifying knockout logic, always test with actual print output to ensure proper white ink registration.

### Receive Type Filtering
Orders have a `receiveType` field:
- `0`: Event pickup (イベント受け取り)
- `1`: Delivery (配送)

Use `process_by_receive_type.sh` to process them separately into different output directories.

### Parallel Processing
For large orders (100+ items), use `index_parallel.py` instead of `index.py`:
- Utilizes multiprocessing for faster layer generation
- Same output format as sequential version
- Best for production runs

### Adobe Illustrator Integration
- Requires macOS (uses AppleScript/osascript)
- Illustrator must be installed and launchable
- `run_ai.sh` automates the JSX script execution
- Process can take several minutes for multiple pages
- Each page becomes a separate .ai file with properly layered structure

## Common Workflows

### Adding New Layer Types
1. Add layer generation logic in `index.py` (search for "# === Layer generation ===" comment)
2. Update `save_layers()` function to include new layer
3. Update JSX scripts to import new layer with correct stacking order
4. Test with small dataset first

### Modifying Card Layout
1. Adjust parameters at top of `index.py` (MARGIN_MM, SPACING_MM, etc.)
2. Test with `--one-page` flag to see layout on single sheet
3. Verify cutlines don't overlap

### CloudFlare R2 Configuration
1. Copy `.env.example` to `.env`
2. Add CloudFlare R2 credentials (account ID, access key, secret, bucket name)
3. Test with `npm run download-order-images`

## Output Directories (Gitignored)
- `output/`: PNG layers by page number
- `output_receive_0/`, `output_receive_1/`: Filtered by receive type
- `ai_output/`: Adobe Illustrator files
- `psd_output/`: Photoshop files (legacy, not currently used)
- `images/`, `illustDisplay/`: Downloaded image assets
- `order_pdfs/`: Generated order summary PDFs
